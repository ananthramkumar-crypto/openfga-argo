apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: openfga
  namespace: argocd
spec:
  project: default
  source:
    repoURL: "https://github.com/your-org/your-repo.git"   # <-- REPLACE with your repo
    targetRevision: HEAD                                   # <-- REPLACE if needed (tag/branch)
    path: charts/openfga
    helm:
      values: |-
        # Fixed values.yaml â€” includes image, grpc, and telemetry keys
        image:
          repository: openfga/openfga
          tag: latest
          pullPolicy: IfNotPresent

        replicaCount: 1

        postgresql:
          enabled: true
          image:
            repository: bitnamilegacy/postgresql
          auth:
            postgresPassword: password
            database: postgres

        datastore:
          engine: postgres
          uri: "postgres://postgres:password@openfga-postgresql:5432/postgres?sslmode=disable"

        grpc:
          addr: "0.0.0.0:8080"

        telemetry:
          metrics:
            enabled: true
            port: 9090
            path: /metrics
          tracing:
            enabled: false

        authn:
          method:
          preshared:
            keys:
              - MYPreSharedToken1

        service:
          type: NodePort
  destination:
    server: "https://kubernetes.default.svc"
    namespace: openfga
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
